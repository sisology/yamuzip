<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">

<head>
    <th:block layout:fragment="userCss">
        <script type="text/javascript" src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
        <style>
            hr { border-top-color: #777; }
        </style>
        <link rel="stylesheet" href="/css/rome.css">
    </th:block>
</head>

<body>
<div id="fh5co-wrapper">
    <div id="fh5co-page">
        <div id="fh5co-header">
            <th:block layout:fragment="headerFragment"></th:block>
        </div>


        <div layout:fragment="content">
            <div class="fh5co-hero" style="height: auto;">
<!--                <div class="fh5co-overlay"></div>-->
                <section class="container-sm" style="padding-top: 150px;">

                    <!--여기부터 본인 페이지 코드 작성-->
                    <div class="row">
                        <div class="col-lg-8" style="margin: 0 auto;">
                            <div class="row">
                                <div class="col-md-4">
                                    <img alt="Bootstrap Image Preview" src="https://www.layoutit.com/img/sports-q-c-140-140-3.jpg"/>
                                </div>
                                <div class="col">
                                    <h3 th:text="${service.serviceTitle}"></h3>
                                    <p>선택한 옵션 :
                                        <span th:text="|${option.optionName}(+${option.optionPrice}원)|" th:if="${option != null}"></span>
                                        <span th:text="없음" th:unless="${option != null}"></span>
                                    </p>
                                </div>
                            </div>
                            <h3 class="text-right" th:text="|총액 ${totalPrice}원|"></h3>

                            <hr>
                            <h3>결제 방식 선택
                            </h3>
                            <div class="option-group">
                                <span class="inputGroup">
                                    <input id="radio1" name="option" value="card" type="radio" checked/>
                                    <label for="radio1">카드결제</label>
                                </span>
                            </div>
                            <hr>
                            <div class="text-center">
                                <button class="btn btn-primary" type="button" th:onclick="kg_request_pay()">결제하기</button>
                            </div>
                        </div>
                    </div>


                    <!--여기까지 본인 페이지 코드 작성-->
                </section>
            </div>
        </div>
        <!-- content -->

    </div>
    <!-- page -->
</div>
<!-- wrapper -->

<th:block layout:fragment="userScript">
    <!--본인 페이지 js 작성-->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>

    <script th:inline="javascript">
        function kg_request_pay() {
            //전달할 데이터
            const $serviceCode = [[${service?.serviceCode}]];
            const $serviceTitle = [[${service?.serviceTitle}]];
            const $reserveDatetime = [[${reserveDatetime}]];
            const $totalPrice = [[${totalPrice}]];

            console.log($totalPrice);
            //kg이니시스 결제 API
            var IMP = window.IMP; // 생략가능
            IMP.init('imp62375564');  // 가맹점 식별코드

            let msg;
            let offset = new Date().getTimezoneOffset() * 60000;

            // IMP.request_pay(param, callback) 결제창 호출
            IMP.request_pay({
                pg: "html5_inicis",
                pay_method: "card",
                merchant_uid: "YMZ" + new Date().getTime(),   // 주문번호
                name: $serviceTitle,
                amount: $totalPrice,                         // 숫자 타입

                buyer_email: "user02@ohgiraffers.com", // #authentication.principal.email
                buyer_name: "유관순", // #authentication.principal.userName
                buyer_tel: "01065845651" // #authentication.principal.phone

            }, function (rsp) { // callback
                console.log(rsp);
                if ( rsp.success ) { //결제 성공시
                    msg = '결제가 완료되었습니다.';
                    var result = {
                        // orderCode : auto increment
                        "serviceCode" : $serviceCode,       // 상품번호
                        "userCode" : 3, // #authentication.principal.userCode
                        "totalPrice" : $totalPrice,          // 결제 금액
                        "reserveDatetime" : $reserveDatetime + 'T00:00:00', // 예약일
                        "optionCode" : [[${option?.optionCode}]] || 0, // 옵션번호

                        "payCode" : rsp.merchant_uid,       // 결제번호
                        "payType" : rsp.pay_method,         // 결제 방법
                        "payStatus" : 'P',                  // 결제 상태 (결제됨 P, 환불됨 R)
                        "payDatetime" : new Date(Date.now() - offset) // 결제일
                    }
                    console.log(result);

                    $.ajax({
                        url : "/order/payment",
                        type : "POST",
                        contentType : "application/json",
                        data : JSON.stringify(result),
                        success : function (res) {
                            location.href=res;
                        },
                        error: function (err) {
                            console.log(err);
                        }
                    }); //ajax
                } else {
                    msg = '결제 실패' + '\n에러내용 : ' + rsp.errorText;
                }
                alert(msg);
            });
        }
    </script>
</th:block>

</body>
</html>
